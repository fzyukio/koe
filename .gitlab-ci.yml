stages:
  # - test
  - build
  # - deploy

# .has_changes_rule:
#   rules:
#     - if: $CI_COMMIT_BRANCH
#       changes:
#         - src/**/*.js
#         - src/**/*.jsx
#         - src/**/*.json
#         - ./*.js
#         - ./*.json

# .no_changes_rule:
#   rules:
#     - if: $CI_COMMIT_BRANCH
#       changes:
#         - src/**/*.js
#         - src/**/*.jsx
#         - src/**/*.json
#         - ./*.js
#         - ./*.json
#       when: never
#     - if: $CI_COMMIT_BRANCH
#       when: always

# lint:
#   stage: test
#   image: registry.gitlab.com/yesolutions/docker-pre-commit
#   extends: .has_changes_rule
#   script:
#     - pre-commit run --all-files

# noop_fallback:
#   stage: test
#   extends: .no_changes_rule
#   script:
#     - echo "No change detected! this pipeline will always run, very quickly."

build:
  stage: build

  image: jdrouet/docker-with-buildx:stable
  
  services:
    - docker:dind

  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    IMAGE_TAG: ${CI_REGISTRY_IMAGE}:$CI_COMMIT_REF_SLUG
    
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker pull $IMAGE_TAG || true
  script:
    - docker buildx create --use
    - |
      docker buildx build \
      --push \
      --platform linux/arm64,linux/amd64 \
      --build-arg BUILDKIT_INLINE_CACHE=1 \
      --cache-from=$IMAGE_TAG \
      -f Dockerfile-basic \
      -t $IMAGE_TAG \
      .